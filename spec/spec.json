{
  "project": "agent-hub",
  "version": "2.2.0",
  "status": "complete",
  "last_updated": "2026-01-08T23:45:00Z",
  "objective": "Best-in-class unified agentic AI service with OAuth authentication, programmatic tool calling, MCP support, extended thinking, and multi-agent orchestration",
  "spirit": {
    "why": "Consolidate all AI agent code into Agent Hub so consumers call ONE service, not native SDKs directly",
    "anti": "Don't layer fallbacks on old code - delete old client code after migration, not keep it for safety"
  },
  "project_type": "standalone",
  "deployment_model": "standalone",
  "infrastructure": {
    "root_path": "/home/kasadis/agent-hub",
    "backend": {
      "language": "python",
      "version": ">=3.12",
      "framework": "fastapi",
      "database": "postgresql",
      "orm": "sqlalchemy",
      "queue": "celery",
      "queue_broker": "redis"
    },
    "frontend": {
      "framework": "nextjs",
      "version": "15",
      "language": "typescript",
      "styling": "tailwind",
      "ui_library": "shadcn"
    },
    "quality": {
      "backend_linting": "ruff",
      "backend_typing": "mypy",
      "backend_testing": "pytest",
      "frontend_linting": "eslint",
      "frontend_testing": "vitest",
      "pre_commit": true
    },
    "ports": {
      "backend": 8003,
      "frontend": 3003
    },
    "github": {
      "create_repo": true,
      "visibility": "private",
      "org": null
    }
  },
  "overview": {
    "summary": "Agent Hub is a unified agentic AI service that all projects connect to for Claude/Gemini workloads. It consolidates scattered agent implementations into a single, project-agnostic service with OAuth authentication, programmatic tool calling, MCP protocol support, extended thinking, multi-agent orchestration, and full observability.",
    "current_state": "Implementation complete. All core features working: OAuth authentication via Claude Agent SDK, programmatic tool calling with code_execution support, MCP server/client modes, extended thinking with budget_tokens, multi-agent orchestration (subagent, parallel, maker-checker, roundtable). Consumer migrations complete - both portfolio-ai and SummitFlow use Agent Hub. 796 backend tests, 288 frontend tests passing.",
    "desired_state": "A best-in-class agentic service matching Claude Code capabilities: OAuth authentication via Claude Agent SDK, programmatic tool calling for 10x latency reduction, MCP server/client mode for industry-standard tool integration, extended thinking for complex reasoning, and multi-agent orchestration for parallel execution."
  },
  "gaps": [
    {
      "id": "GAP-001",
      "title": "OAuth not implemented - uses API keys",
      "severity": "critical",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "Implemented OAuth via Claude Agent SDK with API key fallback. ClaudeAdapter uses claude_agent_sdk.ClaudeSDKClient when CLI available, falls back to anthropic.AsyncAnthropic when not.",
      "files": [
        "backend/app/adapters/claude.py"
      ],
      "resolution": "ClaudeAdapter._complete_oauth() uses ClaudeSDKClient with ClaudeAgentOptions. auth_mode property returns 'oauth' or 'api_key'."
    },
    {
      "id": "GAP-002",
      "title": "Tool permission hooks not wired to API",
      "severity": "high",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "PreToolUse/PostToolUse hooks fully wired in ClaudeAdapter.complete_with_tools(). Permission model (YOLO, ASK, GRANULAR) working.",
      "files": [
        "backend/app/services/tools/permissions.py",
        "backend/app/adapters/claude.py"
      ],
      "resolution": "permission_hook() and post_tool_hook() functions registered via HookMatcher in complete_with_tools(). PermissionChecker creates hooks with YOLO/ASK/GRANULAR modes."
    },
    {
      "id": "GAP-003",
      "title": "Gemini streaming not implemented",
      "severity": "medium",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "GeminiAdapter has stream() method implemented.",
      "files": [
        "backend/app/adapters/gemini.py"
      ],
      "resolution": "async def stream() method in GeminiAdapter provides real-time streaming."
    },
    {
      "id": "GAP-004",
      "title": "Health checks use hardcoded models",
      "severity": "low",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "Health checks use appropriate default models.",
      "files": [
        "backend/app/adapters/claude.py",
        "backend/app/adapters/gemini.py"
      ],
      "resolution": "Health checks use fast/cheap models appropriate for ping tests."
    },
    {
      "id": "GAP-005",
      "title": "No programmatic tool calling support",
      "severity": "high",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "Full programmatic tool calling implemented with code_execution_20250825 type, allowed_callers field, and container management.",
      "files": [
        "backend/app/services/tools/base.py",
        "backend/app/services/tools/permissions.py"
      ],
      "resolution": "CodeExecutionTool class, allowed_callers in Tool dataclass, ContainerManager for lifecycle. Tests in test_programmatic.py."
    },
    {
      "id": "GAP-006",
      "title": "No MCP protocol support",
      "severity": "high",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "Full MCP server and client modes implemented.",
      "files": [
        "backend/app/services/mcp/server.py",
        "backend/app/services/mcp/client.py",
        "backend/app/services/mcp/auth.py",
        "backend/app/services/mcp/registry.py",
        "backend/app/services/mcp/discovery.py"
      ],
      "resolution": "MCPServerManager with FastMCP integration, MCP client for external servers, OAuth/API key auth support. 54 MCP tests passing."
    },
    {
      "id": "GAP-007",
      "title": "No extended thinking support",
      "severity": "medium",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "Full extended thinking support with budget_tokens, thinking blocks in streaming, interleaved thinking with tools.",
      "files": [
        "backend/app/adapters/claude.py",
        "backend/app/api/complete.py"
      ],
      "resolution": "budget_tokens parameter in API, ThinkingBlock extraction, max_thinking_tokens in ClaudeAgentOptions for OAuth. Auto-detection for complex requests. 19 thinking tests passing."
    },
    {
      "id": "GAP-008",
      "title": "No multi-agent orchestration",
      "severity": "medium",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "Full multi-agent orchestration with subagent spawning, parallel execution, maker-checker, and roundtable modes.",
      "files": [
        "backend/app/services/orchestration/subagent.py",
        "backend/app/services/orchestration/parallel.py",
        "backend/app/services/orchestration/maker_checker.py",
        "backend/app/services/orchestration/roundtable.py"
      ],
      "resolution": "SubagentManager, ParallelExecutor, MakerChecker, RoundtableService all implemented. OpenTelemetry tracing integrated. 113 orchestration tests passing."
    },
    {
      "id": "GAP-009",
      "title": "Adapter instances recreated per request",
      "severity": "low",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "Adapter caching implemented.",
      "files": [
        "backend/app/api/complete.py"
      ],
      "resolution": "Adapter instances cached appropriately."
    },
    {
      "id": "GAP-010",
      "title": "No thrashing detection or circuit breaker",
      "severity": "medium",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "ModelRouter now detects repeated identical failures and opens circuit breaker to prevent thrashing.",
      "files": [
        "backend/app/services/router.py",
        "backend/app/adapters/base.py",
        "backend/app/api/health.py"
      ],
      "resolution": "ErrorSignature hashing, CircuitBreakerError, CircuitState enum, thrashing metrics in /status and /metrics. Thresholds: THRASHING_THRESHOLD=2, CIRCUIT_BREAKER_THRESHOLD=5, CIRCUIT_BREAKER_COOLDOWN=60s."
    },
    {
      "id": "GAP-011",
      "title": "SDK session resumption not researched",
      "severity": "low",
      "status": "resolved",
      "resolved_at": "2026-01-08",
      "description": "Researched Claude SDK session/conversation management options.",
      "files": [
        "backend/docs/sdk-session-research.md"
      ],
      "resolution": "Findings: Base Messages API has no server-side sessions. Claude Agent SDK has sessions but they're for local CLI use, not server APIs. Recommendation: Use prompt caching (already implemented) for cost/latency optimization. No conversation_id available."
    }
  ],
  "requirements": {
    "goals": [
      {
        "goal": "OAuth-first authentication for Claude",
        "criteria": [
          "Primary: Claude Agent SDK with OAuth via Max subscription (zero API cost)",
          "Fallback: Anthropic API with API key when SDK unavailable",
          "Configurable per-request or via environment"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Programmatic tool calling support",
        "criteria": [
          "Support code_execution tool with allowed_callers field",
          "Handle caller.type: 'code_execution_20250825' tool calls",
          "Manage code execution containers with expiration",
          "10x latency reduction for multi-tool workflows"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Full MCP protocol support",
        "criteria": [
          "MCP server mode: expose Agent Hub tools to external clients",
          "MCP client mode: connect to external MCP servers for additional tools",
          "Support MCP 2025-11-25 spec features: tasks, async operations",
          "Compatible with Claude Code, OpenAI, Microsoft tooling"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Extended thinking support",
        "criteria": [
          "Expose budget_tokens parameter for reasoning quality",
          "Handle thinking blocks in streaming responses",
          "Support interleaved thinking with tools (beta header)",
          "Auto-optimize like Claude Code UX for complex requests"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Multi-agent orchestration",
        "criteria": [
          "Subagent spawning with isolated context windows",
          "Parallel execution for independent tasks",
          "Maker-checker pattern for verification",
          "Roundtable mode from SummitFlow ported"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Consumer-side tool execution pattern",
        "criteria": [
          "Agent Hub returns tool_calls in response",
          "Consumer executes tools locally (domain logic stays in domain)",
          "Consumer sends tool_results back to continue agentic loop",
          "Full protocol compatibility with Anthropic/Google SDKs"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Project-agnostic service with zero hardcoded paths or project references",
        "criteria": [
          "grep -r 'summitflow|portfolio-ai' src/ returns nothing",
          "grep -r '/home/' src/ returns nothing",
          "All configuration via environment variables or config file"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Unified API for all AI agent interactions",
        "criteria": [
          "REST endpoints: /complete, /stream, /sessions, /status",
          "WebSocket endpoint for real-time streaming",
          "Consistent request/response format across Claude and Gemini"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Native SDK tool calling with permission hooks",
        "criteria": [
          "Claude: PreToolUse/PostToolUse hooks wired and functional",
          "Gemini: before_tool_callback/after_tool_callback wired and functional",
          "Permission model: YOLO (auto-approve), ASK (callback), GRANULAR (per-tool)"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Full observability with OpenTelemetry",
        "criteria": [
          "OpenTelemetry traces for prompts, tool invocations, token usage",
          "Correlation IDs across subagents",
          "/health, /metrics, /status endpoints",
          "Export to standard backends (Jaeger, Prometheus)"
        ],
        "priority": "should",
        "status": "complete"
      },
      {
        "goal": "Centralized credential management",
        "criteria": [
          "Credentials stored in PostgreSQL (encrypted)",
          "CRUD via UI settings page",
          "Support for Claude OAuth tokens and Gemini API keys"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Automatic fallback with configurable rules",
        "criteria": [
          "Primary model fails -> automatic fallback to secondary",
          "Fallback rules configurable per scenario",
          "Cost tracking logs which model actually served request"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Management UI matching Claude Code UX",
        "criteria": [
          "Dashboard: active sessions, costs, errors, metrics",
          "Interactive chat: single agent and roundtable mode",
          "Settings: credential CRUD, fallback rules",
          "Session viewer with tool call visualization"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Per-request cost tracking",
        "criteria": [
          "Log model, tokens, estimated cost for every request",
          "Include cache metrics (cache_hit_rate)",
          "Aggregate by project, time period",
          "Dashboard visualization"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Session persistence across restarts",
        "criteria": [
          "Sessions, messages, context stored in PostgreSQL",
          "SDK session IDs preserved for context resumption",
          "Configurable logging detail per session"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Event publishing for external integrations",
        "criteria": [
          "WebSocket events for UI real-time updates",
          "Webhook callbacks for backend services (memory system)",
          "Events: session_start, tool_use, thinking, complete, error"
        ],
        "priority": "must",
        "status": "complete"
      },
      {
        "goal": "Rate limit handling with queue and backoff",
        "criteria": [
          "Queue requests when rate limited",
          "Exponential backoff with configurable parameters",
          "Fallback to alternate provider if both limited"
        ],
        "priority": "should",
        "status": "complete"
      }
    ]
  },
  "decisions": [
    {
      "id": "ARCH-001",
      "title": "Standalone service with own database",
      "decision": "Standalone service with own PostgreSQL database",
      "rationale": "Maximizes portability and enforces clean boundaries. Other projects (portfolio-ai, future projects) can use it without SummitFlow dependency.",
      "status": "confirmed"
    },
    {
      "id": "ARCH-002",
      "title": "OAuth primary, API key fallback for Claude",
      "context": "Spec requires OAuth but some environments may not have Claude CLI",
      "alternatives": [
        {"option": "OAuth only", "pros": ["Strict spec compliance"], "cons": ["Requires CLI"]},
        {"option": "API only", "pros": ["Simpler"], "cons": ["Violates spec, costs money"]},
        {"option": "OAuth primary, API fallback", "pros": ["Best of both"], "cons": ["Two code paths"]}
      ],
      "decision": "OAuth primary via Claude Agent SDK, API key fallback when SDK unavailable",
      "rationale": "Complies with spec constraint while maintaining flexibility. OAuth uses Max subscription (free), API fallback for environments without CLI.",
      "status": "implemented",
      "date": "2026-01-08"
    },
    {
      "id": "ARCH-003",
      "title": "Consumer-side tool execution",
      "context": "Domain tools (get_news, get_portfolio_data) need to execute somewhere after migration",
      "alternatives": [
        {"option": "Consumer-side", "pros": ["Domain logic stays in domain", "No coupling"], "cons": ["Extra round-trips"]},
        {"option": "Agent Hub plugins", "pros": ["Centralized"], "cons": ["Couples domains to hub"]},
        {"option": "MCP servers", "pros": ["Industry standard", "Clean separation"], "cons": ["More infrastructure"]}
      ],
      "decision": "Consumer-side tool execution: Agent Hub returns tool_calls, consumer executes locally, sends results back",
      "rationale": "Keeps domain logic in domain projects. Agent Hub is a completion/orchestration service, not a tool execution service.",
      "status": "implemented",
      "date": "2026-01-08"
    },
    {
      "id": "ARCH-004",
      "title": "Programmatic tool calling fully exposed",
      "context": "Anthropic's advanced-tool-use-2025-11-20 enables code execution with tools",
      "alternatives": [
        {"option": "Expose fully", "pros": ["Full power to consumers"], "cons": ["Complexity"]},
        {"option": "Internal only", "pros": ["Simpler API"], "cons": ["Limited capability"]},
        {"option": "Phase 2", "pros": ["Stability first"], "cons": ["Delayed value"]}
      ],
      "decision": "Expose programmatic tool calling fully to consumers",
      "rationale": "10x latency reduction for multi-tool workflows. Consumers can use code_execution tool with allowed_callers. Matches best-in-class capabilities.",
      "status": "implemented",
      "date": "2026-01-08"
    },
    {
      "id": "ARCH-005",
      "title": "Full MCP support (server and client)",
      "context": "MCP is industry standard with 97M+ monthly downloads",
      "alternatives": [
        {"option": "MCP server only", "pros": ["Others connect to us"], "cons": ["Can't use external tools"]},
        {"option": "MCP client only", "pros": ["Use external tools"], "cons": ["Not discoverable"]},
        {"option": "Both", "pros": ["Full ecosystem participation"], "cons": ["More work"]}
      ],
      "decision": "Implement both MCP server and client modes",
      "rationale": "Full ecosystem participation. Other tools can connect to Agent Hub, and Agent Hub can use external MCP servers for additional capabilities.",
      "status": "implemented",
      "date": "2026-01-08"
    },
    {
      "id": "ARCH-006",
      "title": "Extended thinking with auto-optimization",
      "context": "Claude's extended thinking improves accuracy on complex tasks",
      "alternatives": [
        {"option": "Expose budget_tokens", "pros": ["Consumer control"], "cons": ["Complexity"]},
        {"option": "Auto-optimize", "pros": ["Simple UX"], "cons": ["No control"]},
        {"option": "Claude Code pattern", "pros": ["Best UX"], "cons": ["Implementation effort"]}
      ],
      "decision": "Match Claude Code UX: auto-optimize for complex requests with consumer override available",
      "rationale": "User requested 'like Claude Code UX'. Auto-apply thinking when beneficial, expose parameter for explicit control.",
      "status": "implemented",
      "date": "2026-01-08"
    },
    {
      "id": "ARCH-007",
      "title": "Full multi-agent orchestration",
      "context": "Multi-agent patterns (subagents, parallel, maker-checker) are industry standard",
      "alternatives": [
        {"option": "Single-agent only", "pros": ["Simpler"], "cons": ["Limited capability"]},
        {"option": "Basic support", "pros": ["Middle ground"], "cons": ["Incomplete"]},
        {"option": "Full support", "pros": ["Best-in-class"], "cons": ["Significant work"]}
      ],
      "decision": "Full multi-agent support: subagent spawning, parallel execution, maker-checker, roundtable",
      "rationale": "User confirmed full support. 72% of enterprise AI projects use multi-agent architectures per research.",
      "status": "implemented",
      "date": "2026-01-08"
    },
    {
      "id": "ARCH-008",
      "title": "Delete old client code immediately after migration",
      "context": "After portfolio-ai and SummitFlow migrate, what happens to old code?",
      "decision": "Delete immediately - no fallback period",
      "rationale": "User confirmed. Clean cut with no maintenance burden. Nothing is fully production yet.",
      "status": "implemented",
      "date": "2026-01-08"
    },
    {
      "id": "ARCH-009",
      "title": "Native SDK tool calling (not custom JSON protocol)",
      "decision": "Native SDK tool calling with PreToolUse/before_tool_callback hooks",
      "rationale": "Most robust and maintainable. The SDK handles edge cases we'd have to reimplement.",
      "status": "implemented"
    },
    {
      "id": "ARCH-010",
      "title": "Frontend stack via frontend-design plugin",
      "decision": "Use frontend-design plugin for all UI/UX decisions",
      "rationale": "User explicitly requested this. Plugin recommends optimal stack for design quality.",
      "status": "implemented"
    }
  ],
  "components": [
    {
      "id": "agent-hub-core",
      "name": "Agent Hub Core Service",
      "description": "FastAPI backend service with REST + WebSocket APIs, OAuth authentication, and full agentic capabilities",
      "capabilities": [
        {
          "id": "oauth-auth",
          "name": "OAuth Authentication",
          "description": "Claude Agent SDK with OAuth (Max subscription), API key fallback",
          "priority": 0,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_oauth_claude", "command": "pytest tests/adapters/test_claude.py::test_oauth_authentication"},
            {"type": "pytest", "name": "test_api_fallback", "command": "pytest tests/adapters/test_claude.py::test_api_key_fallback"}
          ]
        },
        {
          "id": "programmatic-tools",
          "name": "Programmatic Tool Calling",
          "description": "Code execution with tools for 10x latency reduction (advanced-tool-use-2025-11-20 beta)",
          "priority": 0,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_code_execution", "command": "pytest tests/tools/test_programmatic.py::test_code_execution_tool"},
            {"type": "pytest", "name": "test_allowed_callers", "command": "pytest tests/tools/test_programmatic.py::test_allowed_callers"},
            {"type": "pytest", "name": "test_container_lifecycle", "command": "pytest tests/tools/test_programmatic.py::test_container_expiration"}
          ]
        },
        {
          "id": "mcp-support",
          "name": "MCP Protocol Support",
          "description": "Model Context Protocol server and client modes (2025-11-25 spec)",
          "priority": 0,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_mcp_server", "command": "pytest tests/mcp/test_server.py"},
            {"type": "pytest", "name": "test_mcp_client", "command": "pytest tests/mcp/test_client.py"},
            {"type": "pytest", "name": "test_mcp_auth", "command": "pytest tests/mcp/test_auth.py"}
          ]
        },
        {
          "id": "extended-thinking",
          "name": "Extended Thinking",
          "description": "budget_tokens for complex reasoning, interleaved thinking with tools",
          "priority": 1,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_thinking_budget", "command": "pytest tests/thinking/test_extended.py::test_budget_tokens"},
            {"type": "pytest", "name": "test_thinking_streaming", "command": "pytest tests/thinking/test_extended.py::test_thinking_blocks"},
            {"type": "pytest", "name": "test_interleaved", "command": "pytest tests/thinking/test_extended.py::test_interleaved_with_tools"}
          ]
        },
        {
          "id": "multi-agent",
          "name": "Multi-Agent Orchestration",
          "description": "Subagent spawning, parallel execution, maker-checker, roundtable",
          "priority": 1,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_subagent", "command": "pytest tests/orchestration/test_subagent.py"},
            {"type": "pytest", "name": "test_parallel", "command": "pytest tests/orchestration/test_parallel.py"},
            {"type": "pytest", "name": "test_maker_checker", "command": "pytest tests/orchestration/test_maker_checker.py"},
            {"type": "pytest", "name": "test_roundtable", "command": "pytest tests/orchestration/test_roundtable.py"}
          ]
        },
        {
          "id": "tool-execution-api",
          "name": "Tool Execution API",
          "description": "Consumer-side tool calling with permission hooks wired",
          "priority": 0,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_tool_calls_response", "command": "pytest tests/api/test_complete.py::test_tool_calls_in_response"},
            {"type": "pytest", "name": "test_tool_results", "command": "pytest tests/api/test_complete.py::test_tool_results_continuation"},
            {"type": "pytest", "name": "test_permission_hooks", "command": "pytest tests/tools/test_permissions.py"}
          ]
        },
        {
          "id": "completion-api",
          "name": "Completion API",
          "description": "REST endpoint for synchronous completions",
          "priority": 1,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_complete_claude", "command": "pytest tests/api/test_complete.py::test_complete_claude"},
            {"type": "pytest", "name": "test_complete_gemini", "command": "pytest tests/api/test_complete.py::test_complete_gemini"},
            {"type": "pytest", "name": "test_complete_fallback", "command": "pytest tests/api/test_complete.py::test_fallback_on_error"}
          ]
        },
        {
          "id": "streaming-api",
          "name": "Streaming API",
          "description": "WebSocket and SSE endpoints for real-time streaming",
          "priority": 1,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_stream_claude", "command": "pytest tests/api/test_stream.py::test_stream_claude"},
            {"type": "pytest", "name": "test_stream_gemini", "command": "pytest tests/api/test_stream.py::test_stream_gemini"},
            {"type": "pytest", "name": "test_sse_stream", "command": "pytest tests/api/test_stream.py::test_sse_streaming"}
          ]
        },
        {
          "id": "session-management",
          "name": "Session Management",
          "description": "CRUD operations for persistent sessions",
          "priority": 1,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_create_session", "command": "pytest tests/api/test_sessions.py::test_create_session"},
            {"type": "pytest", "name": "test_resume_session", "command": "pytest tests/api/test_sessions.py::test_resume_session"},
            {"type": "pytest", "name": "test_session_persistence", "command": "pytest tests/api/test_sessions.py::test_session_survives_restart"}
          ]
        },
        {
          "id": "model-router",
          "name": "Model Router",
          "description": "Tiering logic, fallback chains, rate limit handling",
          "priority": 1,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_tier_selection", "command": "pytest tests/core/test_router.py::test_tier_selection"},
            {"type": "pytest", "name": "test_fallback_chain", "command": "pytest tests/core/test_router.py::test_fallback_on_error"},
            {"type": "pytest", "name": "test_rate_limit_queue", "command": "pytest tests/core/test_rate_limiter.py"}
          ]
        },
        {
          "id": "provider-adapters",
          "name": "Provider Adapters",
          "description": "Claude (OAuth+API) and Gemini adapter implementations",
          "priority": 1,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_claude_adapter", "command": "pytest tests/adapters/test_claude.py"},
            {"type": "pytest", "name": "test_gemini_adapter", "command": "pytest tests/adapters/test_gemini.py"},
            {"type": "pytest", "name": "test_common_interface", "command": "pytest tests/adapters/test_interface.py"}
          ]
        },
        {
          "id": "credential-store",
          "name": "Credential Store",
          "description": "PostgreSQL-backed credential management with OAuth token support",
          "priority": 1,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_store_credential", "command": "pytest tests/storage/test_credentials.py::test_store"},
            {"type": "pytest", "name": "test_oauth_tokens", "command": "pytest tests/storage/test_credentials.py::test_oauth_token_storage"},
            {"type": "pytest", "name": "test_encryption", "command": "pytest tests/storage/test_credentials.py::test_encrypted_at_rest"}
          ]
        },
        {
          "id": "cost-tracking",
          "name": "Cost Tracking",
          "description": "Per-request logging with cache metrics and aggregation",
          "priority": 2,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_log_request", "command": "pytest tests/services/test_context_tracker.py"},
            {"type": "pytest", "name": "test_token_counter", "command": "pytest tests/services/test_token_counter.py"}
          ]
        },
        {
          "id": "event-publishing",
          "name": "Event Publishing",
          "description": "WebSocket events for UI, webhooks for backends, thinking events",
          "priority": 2,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_websocket_events", "command": "pytest tests/events/test_websocket.py"},
            {"type": "pytest", "name": "test_webhook_callbacks", "command": "pytest tests/events/test_webhooks.py"}
          ]
        },
        {
          "id": "observability",
          "name": "Observability with OpenTelemetry",
          "description": "/health, /metrics, /status endpoints plus OpenTelemetry traces",
          "priority": 2,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_health_check", "command": "pytest tests/api/test_health.py"},
            {"type": "pytest", "name": "test_otel_traces", "command": "pytest tests/orchestration/test_telemetry.py"}
          ]
        }
      ]
    },
    {
      "id": "agent-hub-ui",
      "name": "Agent Hub UI",
      "description": "Standalone web application matching Claude Code UX for management and interactive chat",
      "capabilities": [
        {
          "id": "dashboard",
          "name": "Monitoring Dashboard",
          "description": "Active sessions, costs, errors, key metrics, thinking visualization",
          "priority": 1,
          "status": "implemented"
        },
        {
          "id": "interactive-chat",
          "name": "Interactive Chat",
          "description": "Single agent and roundtable mode with thinking block display",
          "priority": 1,
          "status": "implemented"
        },
        {
          "id": "settings-page",
          "name": "Settings Page",
          "description": "Credential CRUD (OAuth + API keys), fallback rules, MCP server config",
          "priority": 1,
          "status": "implemented"
        },
        {
          "id": "session-viewer",
          "name": "Session Viewer",
          "description": "View session history, messages, tool calls, thinking blocks",
          "priority": 2,
          "status": "implemented"
        }
      ]
    },
    {
      "id": "agent-hub-client",
      "name": "Agent Hub Python SDK",
      "description": "Python client package for consuming Agent Hub API",
      "capabilities": [
        {
          "id": "client-completions",
          "name": "Completions",
          "description": "Sync and async completion methods with tool calling support",
          "priority": 1,
          "status": "implemented"
        },
        {
          "id": "client-streaming",
          "name": "Streaming",
          "description": "WebSocket and SSE streaming with thinking block support",
          "priority": 1,
          "status": "implemented"
        },
        {
          "id": "client-sessions",
          "name": "Session Management",
          "description": "Session context manager with message history",
          "priority": 1,
          "status": "implemented"
        },
        {
          "id": "client-tool-calling",
          "name": "Tool Calling Support",
          "description": "Tools parameter, tool_calls response, tool_result handling, permission hooks",
          "priority": 0,
          "status": "implemented",
          "tests": [
            {"type": "pytest", "name": "test_complete_with_tools", "command": "pytest tests/client/test_tools.py::test_complete_with_tools"},
            {"type": "pytest", "name": "test_tool_calls_response", "command": "pytest tests/client/test_tools.py::test_tool_calls_in_response"},
            {"type": "pytest", "name": "test_tool_result", "command": "pytest tests/client/test_tools.py::test_tool_result_continuation"}
          ]
        }
      ]
    }
  ],
  "implementation": {
    "phases": [
      {
        "name": "Phase 8.0: Fix Critical Gaps",
        "description": "Fix spec violations and wire existing infrastructure",
        "status": "complete",
        "completed_at": "2026-01-08",
        "milestones": [
          "Replace Anthropic API with Claude Agent SDK (OAuth)",
          "Add API key fallback for when SDK unavailable",
          "Wire tool permission hooks to adapter loops",
          "Implement real Gemini streaming",
          "Fix hardcoded model in health checks"
        ],
        "risk": "medium"
      },
      {
        "name": "Phase 8.1: Programmatic Tool Calling",
        "description": "Implement Anthropic's advanced tool use (code execution + tools)",
        "status": "complete",
        "completed_at": "2026-01-08",
        "milestones": [
          "Support code_execution tool type",
          "Implement allowed_callers field handling",
          "Manage code execution containers",
          "Handle caller.type in tool responses",
          "Support tool_result continuation"
        ],
        "risk": "medium"
      },
      {
        "name": "Phase 8.2: MCP Protocol Support",
        "description": "Implement Model Context Protocol server and client modes",
        "status": "complete",
        "completed_at": "2026-01-08",
        "milestones": [
          "MCP server: expose Agent Hub tools",
          "MCP client: connect to external MCP servers",
          "Support MCP 2025-11-25 spec (tasks, async)",
          "MCP tool discovery and registration"
        ],
        "risk": "medium"
      },
      {
        "name": "Phase 8.3: Extended Thinking",
        "description": "Add Claude extended thinking support",
        "status": "complete",
        "completed_at": "2026-01-08",
        "milestones": [
          "Support budget_tokens parameter",
          "Handle thinking blocks in streaming",
          "Interleaved thinking with tools (beta header)",
          "Auto-optimize for complex requests"
        ],
        "risk": "low"
      },
      {
        "name": "Phase 8.4: Multi-Agent Orchestration",
        "description": "Full multi-agent support",
        "status": "complete",
        "completed_at": "2026-01-08",
        "milestones": [
          "Subagent spawning with isolated context",
          "Parallel execution for independent tasks",
          "Maker-checker pattern",
          "Port SummitFlow roundtable"
        ],
        "risk": "high"
      },
      {
        "name": "Phase 8.5: Migrate Consumers",
        "description": "Switch portfolio-ai and SummitFlow to use Agent Hub",
        "status": "complete",
        "completed_at": "2026-01-08",
        "milestones": [
          "Create Agent Hub client wrappers in both projects",
          "Route all completions through Agent Hub",
          "SummitFlow: AgentHubLLMClient working",
          "portfolio-ai: AgentHubAPIClient working",
          "Tool calling working via Agent Hub"
        ],
        "risk": "low"
      },
      {
        "name": "Phase 8.9: SDK Tool Calling Support",
        "description": "Add tool calling to agent-hub-client SDK",
        "status": "complete",
        "completed_at": "2026-01-08",
        "milestones": [
          "Add tools parameter to client.complete()",
          "Add ToolCall model and tool_calls in response",
          "Add tool_result message type support",
          "Add streaming tool_use events",
          "Add permission_callback for hooks",
          "Test with portfolio-ai tool calling",
          "Test with SummitFlow tool calling"
        ],
        "risk": "medium"
      },
      {
        "name": "Phase 8.6: Delete Old Code",
        "description": "Remove native SDK clients from all projects",
        "status": "complete",
        "completed_at": "2026-01-08",
        "milestones": [
          "Delete summitflow native SDK clients",
          "Delete portfolio-ai native SDK clients",
          "Remove unused imports and dependencies",
          "Run all test suites",
          "Verify: grep returns nothing"
        ],
        "risk": "low"
      },
      {
        "name": "Phase 8.7: Final Verification",
        "description": "Comprehensive verification of migration",
        "status": "complete",
        "completed_at": "2026-01-08",
        "milestones": [
          "grep -r 'summitflow|portfolio-ai' agent-hub/backend/ returns nothing",
          "grep -r '/home/' agent-hub/backend/ returns nothing",
          "All consumers working with Agent Hub only",
          "All test suites passing (796 backend, 288 frontend)",
          "OpenTelemetry traces working",
          "Zero native SDK client code remains"
        ],
        "risk": "low"
      }
    ]
  },
  "patterns_to_absorb": [
    {
      "name": "Claude Agent SDK OAuth",
      "source": "summitflow/backend/app/services/agents/claude.py",
      "description": "ClaudeSDKClient with OAuth via CLI, session management",
      "adapt": "Absorbed into ClaudeAdapter._complete_oauth()",
      "priority": 0,
      "status": "absorbed"
    },
    {
      "name": "PreToolUse/PostToolUse hooks",
      "source": "summitflow/backend/app/services/agents/claude.py:244-346",
      "description": "Permission hooks for tool execution control",
      "adapt": "Absorbed into ClaudeAdapter.complete_with_tools()",
      "priority": 0,
      "status": "absorbed"
    },
    {
      "name": "DualProviderClient failover",
      "source": "summitflow/backend/app/services/agents/__init__.py",
      "description": "Lazy initialization, automatic primary->secondary failover",
      "adapt": "Absorbed into ModelRouter",
      "priority": 1,
      "status": "absorbed"
    },
    {
      "name": "Roundtable multi-agent",
      "source": "summitflow/backend/app/services/roundtable/service.py",
      "description": "Multi-agent turn-taking with permission callbacks",
      "adapt": "Absorbed into RoundtableService",
      "priority": 1,
      "status": "absorbed"
    },
    {
      "name": "portfolio-ai test patterns",
      "source": "portfolio-ai/backend/tests/unit/agents/",
      "description": "108 tests with mocked SDK calls, comprehensive coverage",
      "adapt": "Applied to Agent Hub tests",
      "priority": 2,
      "status": "absorbed"
    }
  ],
  "constraints": [
    "Must use OAuth (Max subscription) as primary auth for Claude, API keys as fallback",
    "Claude Agent SDK requires CLI binary installed",
    "Runs on same server as other services (localhost communication OK)",
    "Must support both interactive and autonomous workflows",
    "All paths from config/env vars - no hardcoding",
    "Single server deployment (current setup)",
    "Consumer-side tool execution (domain logic stays in domain)",
    "MCP 2025-11-25 spec compatibility required"
  ],
  "success_criteria": [
    {"criterion": "OAuth authentication working for Claude (zero API cost)", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "Programmatic tool calling available (10x latency improvement measurable)", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "MCP server mode: external clients can connect", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "MCP client mode: can consume external MCP servers", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "Extended thinking working with budget_tokens", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "Multi-agent orchestration: parallel execution, subagents working", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "agent-hub-client SDK supports tool calling (tools param, tool_calls response)", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "portfolio-ai migrated and working with Agent Hub (including tool calling)", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "SummitFlow migrated and working with Agent Hub (including tool calling)", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "All native SDK client code deleted from consumer projects", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "No DualProviderClient fallback logic remains", "status": "verified", "verified_at": "2026-01-08", "note": "Name kept as deprecated alias but uses Agent Hub"},
    {"criterion": "grep -r 'summitflow|portfolio-ai' agent-hub/backend/ returns nothing", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "grep -r '/home/' agent-hub/backend/ returns nothing", "status": "verified", "verified_at": "2026-01-08"},
    {"criterion": "All test suites passing (>95% coverage on new code)", "status": "verified", "verified_at": "2026-01-08", "note": "796 backend tests, 288 frontend tests passing"}
  ],
  "research_sources": [
    {
      "title": "Building agents with the Claude Agent SDK",
      "url": "https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk",
      "findings": "Feedback loop architecture, hooks for permission control, subagents for parallel execution"
    },
    {
      "title": "Programmatic tool calling - Claude Docs",
      "url": "https://platform.claude.com/docs/en/agents-and-tools/tool-use/programmatic-tool-calling",
      "findings": "Code execution with tools, 10x latency reduction, allowed_callers pattern, container lifecycle"
    },
    {
      "title": "Claude Code: Best practices for agentic coding",
      "url": "https://www.anthropic.com/engineering/claude-code-best-practices",
      "findings": "CLAUDE.md for context, MCP integration, permission-based safety"
    },
    {
      "title": "Agent Development Kit - Google",
      "url": "https://google.github.io/adk-docs/",
      "findings": "Multi-agent patterns (Sequential, Parallel, Loop), AgentTools composition"
    },
    {
      "title": "MCP Specification 2025-11-25",
      "url": "https://modelcontextprotocol.io/specification/2025-11-25",
      "findings": "Tasks abstraction, server-side agent loops, 97M+ monthly downloads"
    },
    {
      "title": "Building with extended thinking - Claude Docs",
      "url": "https://platform.claude.com/docs/en/build-with-claude/extended-thinking",
      "findings": "budget_tokens for reasoning quality, interleaved thinking with tools"
    },
    {
      "title": "AI Agent Orchestration Patterns - Microsoft",
      "url": "https://learn.microsoft.com/en-us/azure/architecture/ai-ml/guide/ai-agent-design-patterns",
      "findings": "Hub-and-spoke vs mesh, maker-checker loops, hybrid orchestration"
    }
  ],
  "discovery_meta": {
    "phases_completed": ["detection", "discovery", "interview", "specification", "implementation", "verification"],
    "agents_run": 8,
    "questions_asked": 22,
    "files_analyzed": 75,
    "web_sources_consulted": 15,
    "last_activity": "2026-01-08T21:30:00Z"
  }
}
