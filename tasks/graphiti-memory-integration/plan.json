{
  "title": "Graphiti Memory Integration + Pattern-Blindness Mitigation for Claude Code",
  "type": "feature",
  "priority": 1,
  "complexity": "COMPLEX",
  "objective": "Replace rules files with Graphiti-based progressive disclosure memory system, implementing pattern-blindness mitigation strategies for Claude Code sessions",
  "spirit": "Create a token-efficient memory system where Claude retrieves only relevant context (progressive disclosure), learns from corrections (learning loop), and avoids pattern blindness through curated golden standards and version-aware tooling",
  "spirit_anti": "Do NOT load all rules at session start (defeats progressive disclosure). Do NOT delete rules without archiving. Do NOT allow bad learnings to become canonical without human verification. Do NOT add latency-heavy operations to SessionStart. Do NOT implement Multi-Model Critic in this task (deferred).",
  "done_when": [
    "Rules files archived to ~/.claude/rules.archive/ and removed from active loading",
    "SessionStart hook retrieves context from Graphiti using 3-block injection (Mandates + Guardrails + Reference)",
    "Token usage per session start is ~150-200 tokens instead of 600+ from full rules",
    "save_learning endpoint exists and Claude can call it via curl",
    "Golden standards are stored with confidence=1.0 and always injected when relevant",
    "Version-aware check_dependency_version tool is available",
    "Relevance debugger shows which memories were injected"
  ],
  "acceptance_criteria": [
    {
      "id": "ac-1",
      "criterion": "Rules files migrated to Graphiti with proper scope (GLOBAL/PROJECT) and category (6-category taxonomy)",
      "verify_by": "test",
      "verify_command": "curl -s http://localhost:8003/api/memory/stats | jq '.total > 100'"
    },
    {
      "id": "ac-2",
      "criterion": "Original rules archived to ~/.claude/rules.archive/ with directory structure preserved",
      "verify_by": "test",
      "verify_command": "test -d ~/.claude/rules.archive && ls ~/.claude/rules.archive/*.md 2>/dev/null | wc -l | grep -qE '[1-9][0-9]*'"
    },
    {
      "id": "ac-3",
      "criterion": "SessionStart hook uses 3-block injection: Mandates (always), Guardrails (type-filtered), Reference (semantic)",
      "verify_by": "test",
      "verify_command": "grep -q 'memory-context' ~/.claude/hooks/SessionStart.sh && grep -qE 'mandates|guardrails|reference' ~/.claude/hooks/graphiti-client.sh"
    },
    {
      "id": "ac-4",
      "criterion": "Progressive disclosure reduces token usage - session context is under 300 tokens for typical queries",
      "verify_by": "agent",
      "verify_command": "Measure token count of injected memory context and compare to baseline"
    },
    {
      "id": "ac-5",
      "criterion": "save_learning API endpoint accepts POST with category, content, confidence and stores in Graphiti",
      "verify_by": "test",
      "verify_command": "curl -sf -X POST http://localhost:8003/api/memory/save-learning -H 'Content-Type: application/json' -d '{\"category\": \"gotcha\", \"content\": \"test learning\", \"confidence\": 0.8}' | jq -e '.success == true'"
    },
    {
      "id": "ac-6",
      "criterion": "Golden standards stored with source='golden_standard' are retrieved for relevant queries",
      "verify_by": "test",
      "verify_command": "curl -sf 'http://localhost:8003/api/memory/search?query=coding+standard&include_golden=true' | jq -e '.results | length > 0'"
    },
    {
      "id": "ac-7",
      "criterion": "check_dependency_version tool returns installed version, latest version, and breaking changes",
      "verify_by": "test",
      "verify_command": "curl -sf 'http://localhost:8003/api/tools/check-dependency?library=fastapi&project_path=/home/kasadis/agent-hub/backend' | jq -e '.installed_version'"
    },
    {
      "id": "ac-8",
      "criterion": "Relevance debugger outputs which memories were injected when DEBUG=true",
      "verify_by": "human",
      "verify_command": "Start Claude Code session with DEBUG=true, verify memory-debug block shows retrieved facts with IDs and scores"
    },
    {
      "id": "ac-9",
      "criterion": "Anti-patterns stored with TROUBLESHOOTING_GUIDE category and retrieved via guardrails block",
      "verify_by": "test",
      "verify_command": "curl -sf 'http://localhost:8003/api/memory/search?query=anti-pattern&category=TROUBLESHOOTING_GUIDE' | jq -e '.results | length > 0'"
    },
    {
      "id": "ac-10",
      "criterion": "Plan-Verify-Execute workflow instructions included in session context",
      "verify_by": "human",
      "verify_command": "Start Claude Code session, verify mandates block includes research-before-code instruction"
    }
  ],
  "decisions": [
    {
      "id": "d1",
      "title": "Reference doc storage granularity",
      "options": ["One fact per command", "Functional clusters", "Single document"],
      "outcome": "Functional clusters (~6 nodes by workflow phase) + separate global constraints node. Optimizes for co-locality and token efficiency (~150-200 tokens/query)."
    },
    {
      "id": "d2",
      "title": "Archive location for rules",
      "options": ["~/.claude/rules.archive/", "Git-tracked in repo", "Timestamped backup"],
      "outcome": "~/.claude/rules.archive/ - sibling to rules/, clear naming, out of active loading path."
    },
    {
      "id": "d3",
      "title": "CLI command categorization",
      "options": ["OPERATIONAL_CONTEXT", "DOMAIN_KNOWLEDGE", "Split by type"],
      "outcome": "OPERATIONAL_CONTEXT - CLI commands are operational knowledge for how to run the system."
    },
    {
      "id": "d4",
      "title": "Multi-Model Critic scope",
      "options": ["Include in this task", "Defer to future"],
      "outcome": "Deferred - /ask_gemini already exists. Build memory foundation first, add critic only if errors remain high."
    },
    {
      "id": "d5",
      "title": "Multi-Pattern Survey implementation",
      "options": ["Separate infrastructure", "Checklist in Plan-Verify-Execute"],
      "outcome": "Merged into Plan-Verify-Execute as a checklist item, not separate infrastructure."
    }
  ],
  "constraints": [
    "Must use existing MemoryScope (GLOBAL, PROJECT, TASK) and MemoryCategory (6-category taxonomy)",
    "Must not break existing Graphiti functionality or API endpoints",
    "SessionStart hook must remain performant (<2s added latency)",
    "Rules archival must preserve directory structure for potential rollback"
  ],
  "context": {
    "files_to_modify": [
      "~/.claude/hooks/SessionStart.sh",
      "~/.claude/hooks/graphiti-client.sh",
      "backend/app/services/memory/service.py",
      "backend/app/services/memory/context_injector.py",
      "backend/app/api/memory.py",
      "backend/scripts/migrate_rules_to_graphiti.py"
    ],
    "files_to_create": [
      "backend/app/services/memory/golden_standards.py",
      "backend/app/services/tools/dependency_checker.py",
      "backend/app/api/tools.py"
    ],
    "risks": [
      "Graph poisoning - bad learnings becoming canonical. Mitigation: human verification for promotion.",
      "Retrieval latency - 5-10s on SessionStart. Mitigation: async pre-fetch, cache at project level.",
      "Context thrashing - too-sensitive retrieval. Mitigation: strict similarity thresholds."
    ],
    "testing_strategy": "Integration tests for API endpoints, manual verification for SessionStart hook behavior, token counting for progressive disclosure validation",
    "references": [
      {"title": "Pattern Blindness Mitigation Strategy", "url": "file:///home/kasadis/summitflow/docs/planning/pattern-blindness-mitigation.md"},
      {"title": "Auto-Claude Memory Integration", "url": "file:///home/kasadis/agent-hub/references/Auto-Claude/apps/backend/runners/github/memory_integration.py"},
      {"title": "Session Context Research", "url": "file:///home/kasadis/agent-hub/references/session_context/session_context.md"}
    ]
  },
  "subtasks": [
    {
      "id": "1.1",
      "description": "Audit and categorize existing rules files",
      "steps": [
        "List all rules files in ~/.claude/rules/",
        "Categorize each as: Mandate (always inject), Guardrail (type-filtered), or Reference (semantic)",
        "Identify stale/unnecessary rules for exclusion",
        "Map each rule to MemoryCategory (CODING_STANDARD, TROUBLESHOOTING_GUIDE, etc.)",
        "Document categorization in a markdown file for review"
      ]
    },
    {
      "id": "1.2",
      "description": "Update migration script for proper categorization",
      "steps": [
        "Read existing migrate_rules_to_graphiti.py",
        "Add category inference based on rule content and filename",
        "Add scope assignment (GLOBAL for user prefs, PROJECT for project-specific)",
        "Add golden_standard flag for curated patterns (confidence=1.0)",
        "Add anti-pattern tagging for TROUBLESHOOTING_GUIDE entries",
        "Test with --dry-run flag"
      ]
    },
    {
      "id": "1.3",
      "description": "Create functional clusters for reference docs (st-cli)",
      "steps": [
        "Parse st-cli.md into workflow-based groups",
        "Create ~6 functional cluster nodes: Active workflow, Planning, Import/Export, System, Advanced, Global Constraints",
        "Store each cluster as OPERATIONAL_CONTEXT category",
        "Store ID format rules and anti-patterns as separate TROUBLESHOOTING_GUIDE entries",
        "Verify retrieval returns relevant cluster for test queries"
      ]
    },
    {
      "id": "1.4",
      "description": "Run migration and archive original rules",
      "steps": [
        "Create ~/.claude/rules.archive/ directory",
        "Run migration script (not --dry-run)",
        "Move original rules files to archive (preserve structure)",
        "Verify Graphiti contains migrated content (208+ learnings)",
        "Update SessionStart.sh to not load from rules/ directory"
      ]
    },
    {
      "id": "2.1",
      "description": "Implement 3-block progressive disclosure in context_injector.py",
      "steps": [
        "Read existing context_injector.py",
        "Add get_mandates() - always-inject small set (golden standards, critical constraints)",
        "Add get_guardrails(query) - type-filtered for gotchas/anti-patterns (TROUBLESHOOTING_GUIDE)",
        "Add get_reference(query) - semantic search for workflow/patterns (CODING_STANDARD, OPERATIONAL_CONTEXT)",
        "Combine into inject_progressive_context() method",
        "Add token counting for monitoring"
      ]
    },
    {
      "id": "2.2",
      "description": "Update graphiti-client.sh for 3-block retrieval",
      "steps": [
        "Read existing graphiti-client.sh",
        "Add API call for mandates (always fetched, no query needed)",
        "Add API call for guardrails with project/query context",
        "Add API call for reference with semantic query",
        "Format output with distinct XML blocks (<mandates>, <guardrails>, <reference>)",
        "Add --debug flag for relevance debugger output"
      ]
    },
    {
      "id": "2.3",
      "description": "Update SessionStart.sh hook to use progressive disclosure",
      "steps": [
        "Read existing SessionStart.sh",
        "Replace full rules loading with graphiti-client.sh call",
        "Pass project context for query formation",
        "Add <memory-debug> block when DEBUG=true showing retrieved fact IDs and scores",
        "Test hook produces <memory-context> with 3 distinct blocks"
      ]
    },
    {
      "id": "3.1",
      "description": "Implement golden standard storage and retrieval",
      "steps": [
        "Create golden_standards.py service module",
        "Add store_golden_standard(content, category) method with confidence=1.0",
        "Add get_golden_standards(query) - returns relevant golden standards for mandates block",
        "Mark high-value migrated rules as golden standards",
        "Integrate golden standards into mandates block injection"
      ]
    },
    {
      "id": "3.2",
      "description": "Implement save_learning API endpoint",
      "steps": [
        "Add POST /api/memory/save-learning endpoint to memory.py",
        "Accept category, content, confidence, context fields",
        "Store as provisional learning (status='provisional')",
        "Add duplicate detection via semantic similarity check",
        "Return learning ID and status"
      ]
    },
    {
      "id": "3.3",
      "description": "Add end-of-session learning prompt",
      "steps": [
        "Update /wrap_it skill or Stop.sh hook",
        "Add prompt asking Claude to save learnings discovered during session",
        "Provide curl command format for save_learning endpoint",
        "Test learning capture flow end-to-end"
      ]
    },
    {
      "id": "3.4",
      "description": "Implement relevance debugger",
      "steps": [
        "Add debug output to context_injector showing retrieved memories",
        "Include memory IDs, categories, relevance scores, and content snippets",
        "Format as <memory-debug> block in session context",
        "Only output when DEBUG=true environment variable is set",
        "Test debugger shows useful information for troubleshooting"
      ]
    },
    {
      "id": "4.1",
      "description": "Implement check_dependency_version tool",
      "steps": [
        "Create backend/app/services/tools/dependency_checker.py",
        "Parse pyproject.toml for Python projects (installed versions)",
        "Parse package.json for Node.js projects",
        "Query PyPI/npm registry for latest versions",
        "Identify breaking changes between installed and latest versions",
        "Add GET /api/tools/check-dependency endpoint"
      ]
    },
    {
      "id": "4.2",
      "description": "Implement Plan-Verify-Execute workflow injection",
      "steps": [
        "Create workflow instruction content for mandates block",
        "Include: 1) Discovery - list dependencies, 2) Verification - WebSearch best practices, 3) Compare - check codebase vs docs",
        "Include multi-pattern survey as checklist item (find 3+ examples OR verify against docs)",
        "Store as golden standard with CODING_STANDARD category",
        "Verify workflow appears in session context mandates block"
      ]
    },
    {
      "id": "5.1",
      "description": "Integration testing and validation",
      "steps": [
        "Test rules migration completeness (all rules converted, 100+ learnings)",
        "Test progressive disclosure reduces tokens (measure before/after, target <300 tokens)",
        "Test golden standard retrieval for relevant queries",
        "Test save_learning â†’ retrieval in subsequent session",
        "Test version-aware tool returns correct data for fastapi/pydantic"
      ]
    },
    {
      "id": "5.2",
      "description": "Documentation and cleanup",
      "steps": [
        "Update CLAUDE.md with new memory system usage",
        "Document graphiti-client.sh flags and options",
        "Document save_learning curl format for end-of-session use",
        "Remove references to old rules loading from hooks",
        "Create rollback instructions (restore from ~/.claude/rules.archive/)"
      ]
    }
  ]
}
